<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.5.xsd"
        objectQuotingStrategy="QUOTE_ONLY_RESERVED_WORDS">

    <changeSet id="1" author="Luiz Flavio">

        <sql>
            CREATE TABLE cards (
            id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
            user_id INTEGER NOT NULL,
            card_number VARCHAR(255) NOT NULL,
            duo_date date NOT NULL,
            active BOOLEAN NOT NULL,
            CONSTRAINT pk_cards PRIMARY KEY (id)
            );

            CREATE TABLE credit_cards (
            id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
            user_id INTEGER NOT NULL,
            card_number VARCHAR(255) NOT NULL,
            cvv VARCHAR(255) NOT NULL,
            duo_date date NOT NULL,
            active BOOLEAN NOT NULL,
            CONSTRAINT pk_credit_cards PRIMARY KEY (id)
            );

            CREATE TABLE debit_cards (
            id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
            user_id INTEGER NOT NULL,
            card_number VARCHAR(255) NOT NULL,
            cvv VARCHAR(255) NOT NULL,
            duo_date date NOT NULL,
            active BOOLEAN NOT NULL,
            CONSTRAINT pk_debit_cards PRIMARY KEY (id)
            );

            CREATE TABLE events (
            id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
            name VARCHAR(255) NOT NULL,
            description VARCHAR(255) NOT NULL,
            owner_name VARCHAR(255) NOT NULL,
            owner_phone_number VARCHAR(255) NOT NULL,
            date_time TIMESTAMP WITHOUT TIME ZONE NOT NULL,
            event_status INTEGER NOT NULL,
            CONSTRAINT pk_events PRIMARY KEY (id)
            );

            CREATE TABLE payment_methods (
            id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
            user_id INTEGER NOT NULL,
            active BOOLEAN NOT NULL,
            credit_card_id INTEGER,
            debit_card_id INTEGER,
            created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL,
            CONSTRAINT pk_payment_methods PRIMARY KEY (id)
            );

            CREATE TABLE products (
            id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
            name VARCHAR(255) NOT NULL,
            value DECIMAL NOT NULL,
            active BOOLEAN NOT NULL,
            CONSTRAINT pk_products PRIMARY KEY (id)
            );

            CREATE TABLE recharges (
            id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
            value DECIMAL NOT NULL,
            card_id INTEGER NOT NULL,
            payment_method_id INTEGER NOT NULL,
            created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL,
            CONSTRAINT pk_recharges PRIMARY KEY (id)
            );

            CREATE TABLE tickets (
            id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
            event_id INTEGER NOT NULL,
            payment_method_id INTEGER NOT NULL,
            number VARCHAR(255) NOT NULL,
            ticket_status INTEGER NOT NULL,
            CONSTRAINT pk_tickets PRIMARY KEY (id)
            );

            CREATE TABLE transactions (
            id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
            card_id INTEGER NOT NULL,
            event_id INTEGER NOT NULL,
            product_id INTEGER NOT NULL,
            created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL,
            CONSTRAINT pk_transactions PRIMARY KEY (id)
            );

            CREATE TABLE users (
            id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
            full_name VARCHAR(255) NOT NULL,
            email VARCHAR(255) NOT NULL,
            password VARCHAR(255) NOT NULL,
            enabled BOOLEAN NOT NULL,
            created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL,
            CONSTRAINT pk_users PRIMARY KEY (id)
            );

            ALTER TABLE cards ADD CONSTRAINT FK_CARDS_ON_USER FOREIGN KEY (user_id) REFERENCES users (id);

            ALTER TABLE credit_cards ADD CONSTRAINT FK_CREDIT_CARDS_ON_USER FOREIGN KEY (user_id) REFERENCES users (id);

            ALTER TABLE debit_cards ADD CONSTRAINT FK_DEBIT_CARDS_ON_USER FOREIGN KEY (user_id) REFERENCES users (id);

            ALTER TABLE payment_methods ADD CONSTRAINT FK_PAYMENT_METHODS_ON_CREDIT_CARD FOREIGN KEY (credit_card_id)
            REFERENCES credit_cards (id);

            ALTER TABLE payment_methods ADD CONSTRAINT FK_PAYMENT_METHODS_ON_DEBIT_CARD FOREIGN KEY (debit_card_id)
            REFERENCES debit_cards (id);

            ALTER TABLE payment_methods ADD CONSTRAINT FK_PAYMENT_METHODS_ON_USER FOREIGN KEY (user_id) REFERENCES users
            (id);

            ALTER TABLE recharges ADD CONSTRAINT FK_RECHARGES_ON_CARD FOREIGN KEY (card_id) REFERENCES cards (id);

            ALTER TABLE recharges ADD CONSTRAINT FK_RECHARGES_ON_PAYMENT_METHOD FOREIGN KEY (payment_method_id)
            REFERENCES payment_methods (id);

            ALTER TABLE tickets ADD CONSTRAINT FK_TICKETS_ON_EVENT FOREIGN KEY (event_id) REFERENCES events (id);

            ALTER TABLE tickets ADD CONSTRAINT FK_TICKETS_ON_PAYMENT_METHOD FOREIGN KEY (payment_method_id) REFERENCES
            payment_methods (id);

            ALTER TABLE transactions ADD CONSTRAINT FK_TRANSACTIONS_ON_CARD FOREIGN KEY (card_id) REFERENCES cards (id);

            ALTER TABLE transactions ADD CONSTRAINT FK_TRANSACTIONS_ON_EVENT FOREIGN KEY (event_id) REFERENCES events
            (id);

            ALTER TABLE transactions ADD CONSTRAINT FK_TRANSACTIONS_ON_PRODUCT FOREIGN KEY (product_id) REFERENCES
            products (id);
        </sql>
    </changeSet>

    <changeSet id="2" author="Luiz Flavio">
        <sql>
            ALTER TABLE tickets ADD user_id INTEGER;

            ALTER TABLE tickets ALTER COLUMN user_id SET NOT NULL;

            ALTER TABLE tickets ADD CONSTRAINT FK_TICKETS_ON_USER FOREIGN KEY (user_id) REFERENCES users (id);
        </sql>
    </changeSet>

    <changeSet id="3"
               author="Luiz Flavio">
        <dropForeignKeyConstraint baseTableName="tickets"
                                  constraintName="fk_tickets_on_user"/>
    </changeSet>
    <changeSet id="4"
               author="Luiz Flavio">
        <dropColumn columnName="user_id"
                    tableName="tickets"/>
    </changeSet>
    <changeSet id="5"
               author="Luiz Flavio">
        <dropNotNullConstraint columnDataType="int"
                               columnName="payment_method_id"
                               tableName="tickets"/>
    </changeSet>

    <changeSet id="1664403738192-1"
               author="Luiz Flavio (generated)">
        <createTable tableName="pix">
            <column autoIncrement="true"
                    name="id"
                    type="INT">
                <constraints nullable="false"
                             primaryKey="true"
                             primaryKeyName="pk_pix"/>
            </column>
            <column name="qr_code"
                    type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="1664403738192-2"
               author="Luiz Flavio (generated)">
        <addColumn tableName="payment_methods">
            <column name="pix"
                    type="INT"/>
        </addColumn>
    </changeSet>

    <changeSet id="1664403738192-4"
               author="Luiz Flavio (generated)">
        <addForeignKeyConstraint baseColumnNames="pix"
                                 baseTableName="payment_methods"
                                 constraintName="FK_PAYMENT_METHODS_ON_PIX"
                                 referencedColumnNames="id"
                                 referencedTableName="pix"/>
    </changeSet>
    <changeSet id="1664403738192-5"
               author="Luiz Flavio (generated)">
        <dropForeignKeyConstraint baseTableName="credit_cards"
                                  constraintName="fk_credit_cards_on_user"/>
    </changeSet>
    <changeSet id="1664403738192-6"
               author="Luiz Flavio (generated)">
        <dropForeignKeyConstraint baseTableName="debit_cards"
                                  constraintName="fk_debit_cards_on_user"/>
    </changeSet>
    <changeSet id="1664403738192-7"
               author="Luiz Flavio (generated)">
        <dropForeignKeyConstraint baseTableName="payment_methods"
                                  constraintName="fk_payment_methods_on_credit_card"/>
    </changeSet>
    <changeSet id="1664403738192-8"
               author="Luiz Flavio (generated)">
        <dropForeignKeyConstraint baseTableName="payment_methods"
                                  constraintName="fk_payment_methods_on_debit_card"/>
    </changeSet>
    <changeSet id="1664403738192-9"
               author="Luiz Flavio (generated)">
        <dropTable cascadeConstraints="true"
                   tableName="credit_cards"/>
    </changeSet>
    <changeSet id="1664403738192-10"
               author="Luiz Flavio (generated)">
        <dropTable cascadeConstraints="true"
                   tableName="debit_cards"/>
    </changeSet>
    <changeSet id="1664403738192-11"
               author="Luiz Flavio (generated)">
        <dropColumn columnName="credit_card_id"
                    tableName="payment_methods"/>

        <dropColumn columnName="debit_card_id"
                    tableName="payment_methods"/>
    </changeSet>

    <changeSet id="1664404208473-1"
               author="Luiz Flavio (generated)">
        <addColumn tableName="cards">
            <column name="balance"
                    type="DOUBLE"/>
        </addColumn>
    </changeSet>

    <changeSet id="1667043990061-1"
               author="Luiz Flavio (generated)">
        <addColumn tableName="transactions">
            <column name="status"
                    type="INT"/>
        </addColumn>
    </changeSet>
    <changeSet id="1667043990061-2"
               author="Luiz Flavio (generated)">
        <addNotNullConstraint columnName="status"
                              tableName="transactions"/>
    </changeSet>


    <changeSet id="1667046293204-1"
               author="Luiz Flavio (generated)">
        <addColumn tableName="products">
            <column name="image"
                    type="bytea"/>
        </addColumn>
    </changeSet>

    <changeSet id="1667048235669-1"
               author="Luiz Flavio (generated)">
        <dropColumn columnName="image"
                    tableName="products"/>
    </changeSet>
    <changeSet id="1667048235669-2"
               author="Luiz Flavio (generated)">
        <addColumn tableName="products">
            <column name="image"
                    type="text"/>
        </addColumn>
    </changeSet>

    <changeSet id="1667050073937-1"
               author="Luiz Flavio (generated)">
        <addColumn tableName="events">
            <column name="image"
                    type="text"/>
        </addColumn>
    </changeSet>
    <changeSet id="1667050073937-2"
               author="Luiz Flavio (generated)">
        <addColumn tableName="users">
            <column name="user_image"
                    type="text"/>
        </addColumn>
    </changeSet>

</databaseChangeLog>